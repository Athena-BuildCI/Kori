# 工作流名称
name: Manual Build & Release

# 触发条件：仅手动触发
on:
  workflow_dispatch:
    # 定义用户在手动触发时可以输入的参数
    inputs:
      build_target:
        type: choice # 定义为下拉菜单
        description: '请选择要构建的平台'
        required: true
        default: 'all' # 默认选项
        options:
          - all
          - android
          - desktop
          - ios

jobs:
  #---------------------------------------------------
  # 作业 1: 构建并签名 Android 应用
  #---------------------------------------------------
  build-android:
    name: 'Build Signed Android App'
    if: github.event.inputs.build_target == 'android' || github.event.inputs.build_target == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle Cache
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission to gradlew
        run: chmod +x ./gradlew

      # 从 Secrets 解码密钥库文件
      - name: Decode keystore from base64
        run:
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > $GITHUB_WORKSPACE/release.jks
          
      # 核心步骤：构建签名的 Release APK
      - name: Build Signed Release APK
        env:
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
        run: |
          ./gradlew :composeApp:assembleRelease \
            -Pandroid.injected.signing.store.file=$GITHUB_WORKSPACE/release.jks \
            -Pandroid.injected.signing.store.password=$SIGNING_STORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$SIGNING_KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$SIGNING_KEY_PASSWORD
      
      # 列出生成的文件（用于调试和确认）
      - name: List generated APKs
        run: ls -R composeApp/build/outputs/apk/release/

      # --- 修改点：分别为每个 ABI 的 APK 上传工件 ---
      # 您可以根据您在 build.gradle 中配置的 ABI 列表，修改或增删以下步骤
      - name: Upload arm64-v8a APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk-arm64-v8a
          path: composeApp/build/outputs/apk/release/*-arm64-v8a-*.apk
          if-no-files-found: ignore # 如果没找到文件，忽略错误并继续

      - name: Upload armeabi-v7a APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk-armeabi-v7a
          path: composeApp/build/outputs/apk/release/*-armeabi-v7a-*.apk
          if-no-files-found: ignore

      - name: Upload x86_64 APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk-x86_64
          path: composeApp/build/outputs/apk/release/*-x86_64-*.apk
          if-no-files-found: ignore
      
      - name: Upload x86 APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-apk-x86
          path: composeApp/build/outputs/apk/release/*-x86-*.apk
          if-no-files-found: ignore

  #---------------------------------------------------
  # 作业 2: 构建桌面应用 (未签名)
  #---------------------------------------------------
  build-desktop:
    name: 'Build Unsigned Desktop Apps'
    if: github.event.inputs.build_target == 'desktop' || github.event.inputs.build_target == 'all'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle Cache
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission to gradlew
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew
      
      - name: Build Desktop Package (Unsigned)
        run: ./gradlew :composeApp:packageRelease

      - name: Upload Desktop Artifact
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-desktop-app-${{ matrix.os }}
          path: composeApp/build/compose/binaries/release/app/

  #---------------------------------------------------
  # 作业 3: 构建 iOS 框架 (XCFramework)
  #---------------------------------------------------
  build-ios:
    name: 'Build iOS Framework'
    if: github.event.inputs.build_target == 'ios' || github.event.inputs.build_target == 'all'
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle Cache
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission to gradlew
        run: chmod +x ./gradlew

      - name: Build XCFramework for iOS
        run: ./gradlew :composeApp:assembleXCFramework

      - name: Upload XCFramework
        uses: actions/upload-artifact@v4
        with:
          name: ios-xcframework
          path: composeApp/build/XCFrameworks/release/ComposeApp.xcframework
